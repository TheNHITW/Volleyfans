<h2>Gestione Classifiche Torneo</h2>
<div class="page">

  <!-- ðŸ”¹ Selezione opzioni -->
  <mat-card class="card-section">
    <div class="form-row">
      <mat-form-field appearance="fill">
        <mat-label>Data torneo</mat-label>
        <mat-select [(value)]="selectedDate" (selectionChange)="onDateChange()">
          <mat-option *ngFor="let d of availableDates" [value]="d">{{ d }}</mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field appearance="fill">
        <mat-label>Numero squadre</mat-label>
        <mat-select [(value)]="selectedTeamCount" (selectionChange)="onTeamCountChange()">
          <mat-option *ngFor="let count of [12,13,14,15,16]" [value]="count">{{ count }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </mat-card>

  <!-- ðŸ”¹ Formula suggerita -->
  <mat-card *ngIf="strutturaGironiSuggerita" class="card-section">
    <h4>Formula di gara suggerita:</h4>
    <mat-list>
      <mat-list-item *ngFor="let girone of gironiLettere">
        Girone {{ girone }}: {{ strutturaGironiSuggerita[girone] || 0 }} squadre
      </mat-list-item>
    </mat-list>
    <div class="admin-buttons">
    <button mat-raised-button class="btn-orange" (click)="assegnaGironiAutomaticamente()">
      Assegna gironi automaticamente
    </button>
    </div>
  </mat-card>

  <!-- ðŸ”¹ Squadre selezionate -->
  <mat-card class="card-section">
    <h3>Squadre selezionate ({{ filteredTeams.length }})</h3>
    <mat-list>
      <mat-list-item *ngFor="let team of filteredTeams">{{ team.teamName }}</mat-list-item>
    </mat-list>
  </mat-card>

  <!-- ðŸ”¹ Assegnazione gironi -->
  <mat-card class="card-section">
    <h3>Assegna le squadre ai gironi</h3>
    <div class="table-wrapper">
      <table mat-table [dataSource]="filteredTeams" class="mat-elevation-z8 full-width">

        <!-- Nome squadra -->
        <ng-container matColumnDef="teamName">
          <th mat-header-cell *matHeaderCellDef>Squadra</th>
          <td mat-cell *matCellDef="let team">{{ team.teamName }}</td>
        </ng-container>

        <!-- Girone -->
        <ng-container matColumnDef="girone">
          <th mat-header-cell *matHeaderCellDef>Girone</th>
          <td mat-cell *matCellDef="let team">
            <mat-form-field appearance="outline" class="small-select">
              <mat-select [value]="assegnazioni[team.teamName] || ''"
                          (selectionChange)="onAssignGirone(team.teamName, $event.value)">
                <mat-option value="">--</mat-option>
                <mat-option *ngFor="let lettera of gironiLettere" [value]="lettera">
                  Girone {{ lettera }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="['teamName','girone']"></tr>
        <tr mat-row *matRowDef="let row; columns: ['teamName','girone']"></tr>
      </table>
    </div>
  </mat-card>

  <!-- ðŸ”¹ Composizione gironi -->
  <mat-card class="card-section">
    <h3>Composizione Gironi</h3>
    <div class="gironi-grid">
      <mat-card *ngFor="let lettera of gironiLettere" class="girone-block">
        <h4>Girone {{ lettera }}</h4>
        <mat-list>
          <mat-list-item *ngFor="let team of gironi[lettera]">{{ team.teamName }}</mat-list-item>
        </mat-list>
      </mat-card>
    </div>
  </mat-card>

  <!-- ðŸ”¹ Bottone genera match -->
  <div class="admin-buttons">
    <button mat-raised-button class="btn-orange" (click)="generaMatchGironi()">
      Calcola match gironi
    </button>
  </div>

  <!-- ðŸ”¹ Calendario Match per Round -->
  <mat-card class="card-section" *ngIf="matchList.length > 0">
    <h3>Calendario Match</h3>

    <ng-container *ngFor="let grp of getGroupedRounds()">
      <h4>Round {{ grp.round }}</h4>
      <div class="table-wrapper">
        <table mat-table [dataSource]="grp.matches" class="mat-elevation-z2 full-width">

          <ng-container matColumnDef="girone">
            <th mat-header-cell *matHeaderCellDef>Girone</th>
            <td mat-cell *matCellDef="let m">{{ m.girone }}</td>
          </ng-container>

          <ng-container matColumnDef="teamA">
            <th mat-header-cell *matHeaderCellDef>Team A</th>
            <td mat-cell *matCellDef="let m">{{ m.teamA }}</td>
          </ng-container>

          <ng-container matColumnDef="teamB">
            <th mat-header-cell *matHeaderCellDef>Team B</th>
            <td mat-cell *matCellDef="let m">{{ m.teamB }}</td>
          </ng-container>

          <ng-container matColumnDef="referee">
            <th mat-header-cell *matHeaderCellDef>Arbitro</th>
            <td mat-cell *matCellDef="let m">{{ m.referee }}</td>
          </ng-container>

          <ng-container matColumnDef="field">
            <th mat-header-cell *matHeaderCellDef>Campo</th>
            <td mat-cell *matCellDef="let m">{{ m.field }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="['girone','teamA','teamB','referee','field']"></tr>
          <tr mat-row *matRowDef="let row; columns: ['girone','teamA','teamB','referee','field']"></tr>
        </table>
      </div>
    </ng-container>
  </mat-card>

  <!-- ðŸ”¹ Matrice Risultati -->
  <mat-card class="card-section">
    <h3>Matrice risultati - Tutti i Gironi</h3>

    <ng-container *ngFor="let girone of gironiLettere">
      <div *ngIf="gironi[girone]?.length">
        <h4>Girone {{ girone }}</h4>
        <div class="table-wrapper">
          <table mat-table [dataSource]="gironi[girone]" class="matrice-risultati mat-elevation-z8 full-width">

            <!-- Indice -->
            <ng-container matColumnDef="index">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let row; let i=index">{{ i+1 }}</td>
            </ng-container>

            <!-- Nome squadra -->
            <ng-container matColumnDef="teamName">
              <th mat-header-cell *matHeaderCellDef>Squadra</th>
              <td mat-cell *matCellDef="let row">{{ row.teamName }}</td>
            </ng-container>

            <!-- Colonne dinamiche -->
            <ng-container *ngFor="let squadraCol of gironi[girone]; let j=index" [matColumnDef]="'vs'+j">
              <th mat-header-cell *matHeaderCellDef>{{ j+1 }}</th>
              <td mat-cell *matCellDef="let squadraRow; let i=index">
                <ng-container *ngIf="i !== j; else diagonale">
                  <input matInput class="score-input"
                    [value]="getDisplayValue(girone, squadraRow.teamName, squadraCol.teamName)"
                    (input)="aggiornaRisultatoConVittoria(girone, squadraRow.teamName, squadraCol.teamName, getInputValue($event))"/>
                </ng-container>
                <ng-template #diagonale>â– </ng-template>
              </td>
            </ng-container>

            <!-- Diff V/S -->
            <ng-container matColumnDef="diffVS">
              <th mat-header-cell *matHeaderCellDef>Diff V/S</th>
              <td mat-cell *matCellDef="let row">{{ calcolaDiffVS(girone,row.teamName) }}</td>
            </ng-container>

            <!-- Punti totali -->
            <ng-container matColumnDef="puntiTotali">
              <th mat-header-cell *matHeaderCellDef>Punti totali</th>
              <td mat-cell *matCellDef="let row">{{ calcolaPuntiTotali(girone,row.teamName) }}</td>
            </ng-container>

            <!-- Diff punti -->
            <ng-container matColumnDef="diffPunti">
              <th mat-header-cell *matHeaderCellDef>Diff. Punti</th>
              <td mat-cell *matCellDef="let row">{{ calcolaDifferenzaPunti(girone,row.teamName) }}</td>
            </ng-container>

            <!-- righe -->
            <tr mat-header-row *matHeaderRowDef="getColumnsForGirone(girone)"></tr>
            <tr mat-row *matRowDef="let row; columns: getColumnsForGirone(girone)"></tr>
          </table>
        </div>
      </div>
    </ng-container>
  </mat-card>

  <!-- ðŸ”¹ Classifiche finali -->
  <mat-card class="card-section">
    <h3>Classifiche finali (per girone)</h3>

    <ng-container *ngFor="let girone of gironiLettere">
      <div *ngIf="gironi[girone]?.length">
        <h4>Girone {{ girone }}</h4>
        <div class="table-wrapper">
          <table mat-table [dataSource]="getClassificaGirone(girone)" class="mat-elevation-z8 full-width classifica-table responsive-table">

            <ng-container matColumnDef="rank">
              <th mat-header-cell *matHeaderCellDef>#</th>
              <td mat-cell *matCellDef="let s; let i=index">{{ i+1 }}</td>
            </ng-container>

            <ng-container matColumnDef="team">
              <th mat-header-cell *matHeaderCellDef>Squadra</th>
              <td mat-cell *matCellDef="let s">{{ s.team }}</td>
            </ng-container>

            <ng-container matColumnDef="coeffVS">
              <th mat-header-cell *matHeaderCellDef>Coeff V/S</th>
              <td mat-cell *matCellDef="let s">{{ s.coeffVS | number:'1.2-2' }}</td>
            </ng-container>

            <ng-container matColumnDef="puntiTotali">
              <th mat-header-cell *matHeaderCellDef>Punti totali</th>
              <td mat-cell *matCellDef="let s">{{ s.puntiTotali }}</td>
            </ng-container>

            <ng-container matColumnDef="diffPunti">
              <th mat-header-cell *matHeaderCellDef>Diff. punti</th>
              <td mat-cell *matCellDef="let s">{{ s.diffPunti }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="['rank','team','coeffVS','puntiTotali','diffPunti']"></tr>
            <tr mat-row *matRowDef="let row; columns: ['rank','team','coeffVS','puntiTotali','diffPunti']"></tr>
          </table>
        </div>
      </div>
    </ng-container>
  </mat-card>

  <!-- ðŸ”¹ Classifica Generale -->
<mat-card class="card-section">
  <h3>Classifica Generale</h3>
  <div class="table-wrapper">
    <table mat-table [dataSource]="getClassificaGenerale()" class="mat-elevation-z8 full-width classifica-table">

      <!-- Rank -->
      <ng-container matColumnDef="rank">
        <th mat-header-cell *matHeaderCellDef>#</th>
        <td mat-cell *matCellDef="let s; let i = index">{{ i + 1 }}</td>
      </ng-container>

      <!-- Squadra -->
      <ng-container matColumnDef="team">
        <th mat-header-cell *matHeaderCellDef>Squadra</th>
        <td mat-cell *matCellDef="let s">{{ s.team }}</td>
      </ng-container>

      <!-- Girone -->
      <ng-container matColumnDef="girone">
        <th mat-header-cell *matHeaderCellDef>Girone</th>
        <td mat-cell *matCellDef="let s">{{ s.girone }}</td>
      </ng-container>

      <!-- Coeff VS -->
      <ng-container matColumnDef="coeffVS">
        <th mat-header-cell *matHeaderCellDef>Coeff V/S</th>
        <td mat-cell *matCellDef="let s">{{ s.coeffVS | number:'1.2-2' }}</td>
      </ng-container>

      <!-- Punti totali -->
      <ng-container matColumnDef="puntiTotali">
        <th mat-header-cell *matHeaderCellDef>Punti totali</th>
        <td mat-cell *matCellDef="let s">{{ s.puntiTotali }}</td>
      </ng-container>

      <!-- Diff Punti -->
      <ng-container matColumnDef="diffPunti">
        <th mat-header-cell *matHeaderCellDef>Diff. punti</th>
        <td mat-cell *matCellDef="let s">{{ s.diffPunti }}</td>
      </ng-container>

      <!-- Righe -->
      <tr mat-header-row *matHeaderRowDef="displayedColumnsGenerale"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsGenerale"></tr>
    </table>
  </div>
</mat-card>

  

  <div class="admin-buttons">
    <button mat-raised-button class="btn-blue" (click)="generaPDFRisultati()">
      ðŸ“„ Esporta risultati in PDF
    </button>
  </div>
</div>
